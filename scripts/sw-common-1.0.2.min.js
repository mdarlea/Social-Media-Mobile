/*
 * sw-common
 * AngularJS common utility functions and token-based authentication service

 * Created By: Michelle Darlea <mdarlea@gmail.com> (https://github.com/mdarlea)
 * https://github.com/mdarlea/angular-common

 * Version: 1.0.2 - 2015-07-20
 * License: ISC
 */
angular.module("sw.common",["swCommon","swAuth"]),function(){"use strict";angular.module("swCommon",[]);angular.module("swCommon").factory("PagedDataService",["$http","$q","swAppSettings",function(a,b,c){var d=c.apiServiceBaseUri,e=function(a,b){this.baseUrl=a,this.fixedPage=b&&b.fixedPage?b.fixedPage:!1;var c={filterOptions:b&&b.filterOptions?b.filterOptions:{},sortOptions:b&&b.sortOptions?b.sortOptions:{},pagingOptions:b&&b.pagingOptions?b.pagingOptions:{}};this.data=$.extend(!0,{},{loading:!1,items:[],totalRecords:0,selected:[],totalPages:0,filterOptions:{filterText:"",externalFilter:"searchText",useExternalFilter:!0},sortOptions:{fields:[],directions:["asc"]},pagingOptions:{pageSizes:[5,10,20,50,100],pageSize:10,currentPage:0}},c)};return e.prototype=function(){function c(a){var b=a?a:{},c=this.fixedPage?this.data.pagingOptions.currentPage:null,d=null;if(!this.fixedPage){var e=this.data.items.length-1;e>-1&&(d=this.data.items[e].Id)}return{queryOptions:$.extend(!0,{},b,{sortByField:this.data.sortOptions.fields.length>0?this.data.sortOptions.fields[0]:null,sortDescending:this.data.sortOptions.directions.length>0?"desc"===this.data.sortOptions.directions[0]:!1,searchText:this.data.filterOptions.filterText}),page:c,minIdentity:d,pageSize:this.data.pagingOptions.pageSize}}function f(b,e,g){var h=this._(c)(b);this.data.loading=!0;var i=this;a.post(d+this.baseUrl,h).success(function(a){if(g){e.notify(h);var c=i.data.filterOptions.filterText!==h.queryOptions.searchText;if(c)return void i._(f)(b,e,!0)}if(i.fixedPage)i.data.items=a.Content;else{if(i.data.pagingOptions.currentPage<1)i.data.items=a.Content;else for(var d=0;d<a.Content.length;d++)i.data.items.push(a.Content[d]);i.data.pagingOptions.currentPage++}i.data.totalRecords=a.TotalRecords,i.data.loading=!1,e.resolve(a)}).error(function(a){i.data.loading=!1,e.reject(a.Message)})}return{constructor:e,init:function(){this.data.items=[],this.data.totalRecords=0,this.data.totalPages=0,this.data.pagingOptions.currentPage=0,this.data.loading=!1},find:function(a){if(this.data.loading){var c=b.defer();return c.reject(),c.promise}var d=b.defer();return this._(f)(a,d,!1),d.promise},search:function(a){var c=b.defer();return this.data.loading?(c.reject(),c.promise):(this.data.pagingOptions.currentPage=0,this._(f)(a,c,!0),c.promise)},_:function(a){var b=this;return function(){return a.apply(b,arguments)}}}}(),e}])}(),function(){"use strict";angular.module("swCommon").provider("swAppSettings",function(){var a={};this.setSettings=function(b){a=b},this.$get=[function(){var b=$.extend(!0,{indexPage:"/home",apiServiceBaseUri:"http://",clientId:"swCommon"},a);return b}]})}(),function(){"use strict";angular.module("swCommon").value("$utilities",{parseQueryString:function(a){var b,c,d,e,f,g,h={};if(!a)return h;for(var i=a.split("&"),j=0;j<i.length;j++)b=i[j],c=b.indexOf("="),-1===c?(d=b,e=null):(d=b.substr(0,c),e=b.substr(c+1)),f=decodeURIComponent(d),g=decodeURIComponent(e),h[f]=g;return h},getFragment:function(a){var b=a.indexOf("?");return b>0?this.parseQueryString(a.substr(b+1)):{}}})}(),function(){"use strict";angular.module("swAuth",["swCommon"]);angular.module("swAuth").factory("AuthenticationToken",[function(){var a=function(a){this.token=a};return a.prototype={isExpired:function(){return!1}},a}])}(),function(){"use strict";angular.module("swAuth").factory("$authService",["$http","$q","$authenticationTokenFactory","swAppSettings",function(a,b,c,d){var e=d.apiServiceBaseUri,f={authentication:{isAuth:!1,isAuthorizing:!1,userName:"",useRefreshTokens:!1},externalAuthData:{provider:"",userName:"",externalAccessToken:"",externalAccessVerifier:null},saveRegistration:function(b){return f.logOut(),a.post(e+"api/account/register",b).then(function(a){return a})},obtainAccessToken:function(c,g){var h=b.defer(),i="ObtainLocalAccessToken",j=e+"api/"+(c||"Account")+"/"+i;f.authentication.isAuthorizing=!0;var k=$.extend(!0,{},g,{clientId:d.clientId});return a.get(j,{params:k}).success(function(a){var b=a.hasRegistered;f.externalAuthData.provider=k.provider,b?f._authorize(a):(f.authentication.isAuth=!1,f.authentication.userName="",f.authentication.useRefreshTokens=!1,f.externalAuthData.userName=a.externalUserName,f.externalAuthData.externalAccessToken=a.externalAccessToken,f.externalAuthData.externalAccessVerifier=a.externalAccessVerifier),f.authentication.isAuthorizing=!1,h.resolve(a)}).error(function(a,b){f.logOut(),f.authentication.isAuthorizing=!1,h.reject(a.Message)}),h.promise},login:function(g){var h="grant_type=password&username="+g.userName+"&password="+g.password;g.useRefreshTokens&&(h=h+"&client_id="+d.clientId);var i=b.defer();return a.post(e+"token",h,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){g.useRefreshTokens?c.createFrom(a,!0):c.createFrom(a,!1),f.authentication.isAuth=!0,f.authentication.userName=g.userName,f.authentication.useRefreshTokens=g.useRefreshTokens,i.resolve(a)}).error(function(a,b){f.logOut(),i.reject(a)}),i.promise},logOut:function(){c.removeToken(),f.authentication.isAuth=!1,f.authentication.userName="",f.authentication.useRefreshTokens=!1},fillAuthData:function(){var a=c.getToken();if(a){var b=a.token;f.authentication.isAuth=!0,f.authentication.userName=b.userName,f.authentication.useRefreshTokens=b.useRefreshTokens}},refreshToken:function(){var g=b.defer(),h=c.getToken();if(h&&h.useRefreshTokens){var i=h.token,j="grant_type=refresh_token&refresh_token="+i.refreshToken+"&client_id="+d.clientId;c.removeToken(),a.post(e+"token",j,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){c.createFrom(a,!0),g.resolve(a)}).error(function(a,b){f.logOut(),g.reject(a)})}return g.promise},register:function(c){var g=b.defer(),h=angular.extend({},c,{clientId:d.clientId});return a.post(e+"api/account/register",h).success(function(a){f._authorize(a),g.resolve(a)}).error(function(a,b){f.logOut(),g.reject(a)}),g.promise},registerExternal:function(c){var g=b.defer(),h=angular.extend({},c,{clientId:d.clientId});return a.post(e+"api/account/registerexternal",h).success(function(a){f._authorize(a),g.resolve(a)}).error(function(a,b){f.logOut(),g.reject(a)}),g.promise},authorize:function(a){f.externalAuthData.provider=a.provider,this._authorize(a)},_authorize:function(a){f.externalAuthData.userName=a.externalUserName,f.externalAuthData.externalAccessToken=null,f.externalAuthData.externalAccessVerifier=null,c.createFrom(a),f.authentication.isAuth=!0,f.authentication.userName=a.userName,f.authentication.useRefreshTokens=!1}};return f}])}(),function(){"use strict";angular.module("swAuth").factory("$authenticationTokenFactory",["swAppSettings","localStorageService","AuthenticationToken",function(a,b,c){var d="authorizationData_"+a.clientId,e={createFrom:function(a,c){var e=$.extend(!0,{},a,{refreshToken:c?a.refresh_token:"",useRefreshTokens:c?c:!1});return b.set(d,e),e},removeToken:function(){b.remove(d)},getToken:function(){var a=b.get(d);return a?new c(a):null}};return e}])}();